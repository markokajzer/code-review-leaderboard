#!/usr/bin/env ruby

require "active_support"
require "awesome_print"

require_relative "../lib/config"

require_relative "../lib/pulls"
require_relative "../lib/repository"
require_relative "../lib/reviews"

require_relative "../lib/formatter"

Config.initialize!

raise Config::ConfigurationError, "Access token is required" if Config.access_token.nil?
raise Config::ConfigurationError, "Repository is required" if Config.repository.nil?

repository = Repository.new(name: Config.repository)
puts "Fetching pull requests for #{repository.name}..."

pulls = repository.pulls
puts "Found #{pulls.size} pull requests."

reviews =
  pulls.flat_map.with_index do |pull, index|
    print "Fetching reviews for all pull requests... #{index + 1}/#{pulls.size}" + " " * 10 + "\r"

    Reviews.for(repository:, pull:)
  end
puts "Found #{reviews.size} reviews."

puts Formatter.new(reviews).to_table
